def package_name = 'tacplus'
def os_to_build = ['Ubuntu1604', 'CentOS7']
def version_number = "4.0.4.28"
def osmap = ['CentOS7':['packaging':'rpm', 'init':'systemd', 'distro':'el7', 
                        'build_env':'alanfranz/fwd-centos-7:latest', 
                        'build_deps':['gcc', 'bison', 'flex', 'm4', 'pam-devel', 'tcp_wrappers', 'tcp_wrappers-devel'], 
                        'install_deps':['pam-devel', 'tcp_wrappers'], test_env:'centos:7'],
             'CentOS6':['packaging':'rpm', 'init':'sysv', 'distro':'el6', 
                        'build_env':'alanfranz/fwd-centos-6:latest',
                        'build_deps':['gcc', 'bison', 'flex', 'm4', 'pam-devel', 'tcp_wrappers', 'tcp_wrappers-devel'],
                        'install_deps':['pam-devel', 'tcp_wrappers'], test_env:'centos:6'],
             'Ubuntu1604':['packaging':'deb', 'init':'systemd', 'distro':'xenial', 
                           'build_env':'alanfranz/fwd-ubuntu-xenial:latest',
                           'build_deps':['gcc', 'bison', 'flex', 'm4', 'libpam0g-dev', 'libwrap0', 'libwrap0-dev'],
                           'install_deps':['libpam0g-dev', 'libwrap0'], test_env:'ubuntu:xenial'],
             'Ubuntu1404':['packaging':'deb', 'init':'sysv', 'distro':'trusty',
                           'build_env':'alanfranz/fwd-ubuntu-trusty:latest',
                           'build_deps':['gcc', 'bison', 'flex', 'm4', 'libpam0g-dev', 'libwrap0', 'libwrap0-dev'],
                           'install_deps':['libpam0g-dev', 'libwrap0'], test_env:'ubuntu:trusty'],
            ]

def branches = [:]

for (x in os_to_build) {
  def OS = x
  def install_deps = ""
  if(osmap[OS]['install_deps']) {
    install_deps = "--depends " + osmap[OS]['install_deps'].join(' --depends ')
  }
  def rpm_dist = ""
  if(osmap[OS]['distro'] && osmap[OS]['packaging'] == 'rpm') {
    rpm_dist = "--rpm-dist ${osmap[OS]['distro']}"
  }
  def deb_systemd = ""
  if(osmap[OS]['init'] == 'systemd' && osmap[OS]['packaging'] == 'deb') {
    deb_systemd = "--deb-systemd ../dist/systemd/etc/systemd/system/tac_plus.service"
  }
  else if (osmap[OS]['init'] == 'sysv' && osmap[OS]['packaging'] == 'deb') {
    deb_systemd = "--deb-init ../dist/sysv/etc/rc.d/init.d/tac_plus"
  }
  def deb_dist = ""
  if(osmap[OS]['packaging'] == 'deb') {
    deb_dist = "-${osmap[OS]['distro']}"
  }
  branches[OS] = {
    node {
      docker.image(osmap[OS]['build_env']).inside('-u 0') {
        stage('setup_env') {
          if(osmap[OS]['packaging'] == 'rpm') {
            sh "yum -y install ${osmap[OS]['build_deps'].join(' ')}"
          } else {
            sh "apt-get update; apt-get install -y ${osmap[OS]['build_deps'].join(' ')}"
          }
        }
        stage('download') {
          git url: 'git@github.com:bordershot/shrubbery_tac_plus.git'
        }
        stage('build') {
          sh "rm -rf $WORKSPACE/fpm-build-${OS} || true"
          sh "mkdir $WORKSPACE/fpm-build-${OS}"
          sh "rm -rf $WORKSPACE/out || true"
          sh "mkdir $WORKSPACE/out"
          sh 'if [ -d "dist" ]; then [ -d "dist/default" ] && rsync -a dist/default/ $OUTPUT_DIR; fi'
          if(osmap[OS]['init'] == 'systemd') {
            sh '[ -d "dist/systemd" ] && rsync -a dist/systemd/ $OUTPUT_DIR'
          } else {
            sh '[ -d "dist/sysv" ] && rsync -a dist/sysv/ $OUTPUT_DIR'
          }
          sh "./configure && make && make install DESTDIR=$WORKSPACE/fpm-build-${OS}"
        }
        stage('package') {
          sh "cd $WORKSPACE/out; fpm -f -t ${osmap[OS]['packaging']} -s dir -n ${package_name}${deb_dist} --version ${version_number} --iteration ${BUILD_NUMBER} ${rpm_dist}${deb_systemd} --description \"DD TacPlus\" ${install_deps} -C $WORKSPACE/fpm-build-${OS} ."
          sh "rm -rf $WORKSPACE/fpm-build-${OS}"
        }
      }
      stage('test') {
        docker.image(osmap[OS]['test_env']).inside('-u 0') {
          if(osmap[OS]['packaging'] == 'rpm') {
            sh "yum -y install $WORKSPACE/out/${package_name}*.rpm"
          } else {
            sh "apt-get update; dpkg -i $WORKSPACE/out/${package_name}*.deb || /bin/true; apt-get -f -y install"
          }
          sh 'systemctl tac_plus status'
        }
      }
      stage('publish') {
        archiveArtifacts("out/${package_name}*.${osmap[OS]['packaging']}")
      }
    }
  }
}

parallel branches
